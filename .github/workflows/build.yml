name: Build iOS IPA for AltStore

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install project dependencies
        run: |
          npm install
          npm install lucide-react@latest
          
      - name: Build Web App
        run: npm run build

      - name: Install Capacitor Dependencies
        run: |
          # 清理并安装 Capacitor 核心依赖
          npm install @capacitor/core @capacitor/cli --save
          npm install @capacitor/ios --save-dev
          
          # 初始化 iOS 平台
          npx cap add ios
          
          # 修改 Podfile 设置 iOS 版本
          cd ios/App
          
          # 备份原始的 Podfile
          cp Podfile Podfile.backup
          
          # 创建新的 Podfile 内容
          cat > Podfile << 'EOF'
          require_relative '../node_modules/@capacitor/ios/Capacitor/CapacitorPodspecs/CapacitorPodspecs.rb'
          
          platform :ios, '14.0'
          
          target 'App' do
            # Add your Pods here
            pod 'Capacitor', :path => '../node_modules/@capacitor/ios'
            pod 'CapacitorCordova', :path => '../node_modules/@capacitor/ios'
            
            # App target pods
            install! 'cocoapods', :disable_input_output_paths => true
          end
          EOF
          
          # 安装 Pod 依赖
          pod install --verbose
          cd ../../
          
          # 同步到 iOS 项目
          npx cap sync ios

      - name: Build Unsigned IPA
        run: |
          cd ios/App
          
          # 创建 Xcode 项目文件（如果不存在）
          if [ ! -f "App.xcworkspace/contents.xcworkspacedata" ]; then
            xcodebuild -project App.xcodeproj -list
          fi
          
          # 清理构建目录
          rm -rf build
          
          # 归档项目
          xcodebuild archive \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath App.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            -allowProvisioningUpdates
          
          # 导出为 IPA
          xcodebuild -exportArchive \
            -archivePath App.xcarchive \
            -exportOptionsPlist ../../exportOptions.plist \
            -exportPath .
            
          # 如果导出成功，重命名 IPA 文件
          if [ -f "App.ipa" ]; then
            mv App.ipa EarPro.ipa
          else
            # 如果导出失败，使用手动方法创建 IPA
            mkdir -p Payload
            cp -r App.xcarchive/Products/Applications/App.app Payload/
            zip -r EarPro.ipa Payload
            rm -rf Payload
          fi

      - name: Create export options plist
        run: |
          cat > exportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>development</string>
            <key>teamID</key>
            <string></string>
            <key>compileBitcode</key>
            <false/>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <false/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>signingCertificate</key>
            <string></string>
            <key>provisioningProfiles</key>
            <dict>
              <key>com.earpro.training</key>
              <string></string>
            </dict>
            <key>thinning</key>
            <string>&lt;none&gt;</string>
          </dict>
          </plist>
          EOF

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: EarPro-IPA
          path: ios/App/EarPro.ipa
