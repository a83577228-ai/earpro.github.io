name: Build iOS IPA for AltStore

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install Dependencies
        run: |
          npm ci
          npm install -g @capacitor/cli

      - name: Build Web App
        run: npm run build

      - name: Setup Capacitor iOS
        run: |
          npx cap add ios
          npx cap sync ios

      - name: Configure iOS Project for Audio
        run: |
          cd ios/App
          
          # 创建音频目录
          mkdir -p App/public/audio
          
          # 复制示例音频文件（这里可以替换为你的本地音频）
          # 注意：GitHub Actions 中需要提前准备音频文件
          # 你可以将音频文件放在项目的 audio/ 目录下
          if [ -d "../../audio" ]; then
            cp -r ../../audio/* App/public/audio/
          fi
          
          # 修改 Info.plist 配置音频权限
          /usr/libexec/PlistBuddy -c "Add :NSAppTransportSecurity dict" App/Info.plist || true
          /usr/libexec/PlistBuddy -c "Add :NSAppTransportSecurity:NSAllowsArbitraryLoads bool true" App/Info.plist
          
          /usr/libexec/PlistBuddy -c "Add :UIBackgroundModes array" App/Info.plist || true
          /usr/libexec/PlistBuddy -c "Add :UIBackgroundModes:0 string audio" App/Info.plist
          
          /usr/libexec/PlistBuddy -c "Add :NSMicrophoneUsageDescription string 用于播放音程训练声音" App/Info.plist
          
          # 设置 Bundle 信息
          /usr/libexec/PlistBuddy -c "Set :CFBundleIdentifier com.earpro.training" App/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName EarPro" App/Info.plist
          /usr/libexec/PlistBuddy -c "Set :MinimumOSVersion 13.0" App/Info.plist

      - name: Build iOS Project
        run: |
          cd ios/App
          
          # 清理项目
          xcodebuild clean -workspace App.xcworkspace -scheme App
          
          # 构建项目
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath ./App.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Create IPA Package
        run: |
          cd ios/App
          
          # 创建 Payload 目录并复制应用
          mkdir -p Payload
          cp -r App.xcarchive/Products/Applications/App.app Payload/
          
          # 清理符号文件减少体积
          find Payload -name "*.dSYM" -type d -exec rm -rf {} + || true
          
          # 压缩成 IPA
          zip -r EarPro.ipa Payload
          
          # 清理临时文件
          rm -rf Payload App.xcarchive

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: EarPro-iOS-IPA
          path: ios/App/EarPro.ipa

      - name: Create App Info File
        run: |
          echo "App Name: EarPro" > app-info.txt
          echo "Bundle ID: com.earpro.training" >> app-info.txt
          echo "Build Date: $(date)" >> app-info.txt
          echo "For AltStore installation:" >> app-info.txt
          echo "1. Download the IPA from Artifacts" >> app-info.txt
          echo "2. Open with AltServer" >> app-info.txt
          echo "3. Trust developer in Settings > General > Device Management" >> app-info.txt

      - name: Upload App Info
        uses: actions/upload-artifact@v4
        with:
          name: App-Info
          path: app-info.txt
